class GraspSet():

    def __init__(self, fname):
        self.json = json.load(open(fname))
        self.grasps = []
        self.targets = []
        for grasp in self.json:
            qdict, pdict = grasp["gripper_pose"]["orientation"], grasp["gripper_pose"]["position"]
            quat = np.array([qdict['w'], qdict['x'], qdict['y'], qdict['z']])
            pos = np.array([pdict['x'], pdict['y'], pdict['z']])
            self.grasps.append(Grasp(quat, pos, self))
            
    def __getitem__(self, i):
        return self.grasps[i]

    def __len__(self):
        return len(self.grasps)
        
    def GetTargets(self, obj):
        targets = []
        bad = []
        for i,g in enumerate(self.grasps):
            t = g.GetTargetPose(obj)
            if t is not None:
                targets.append(t)
            else:
                bad.append(i)
        self.grasps = [g for i,g in enumerate(self.grasps) if i not in bad]
        return targets
        
        
class Grasp():

    initial = rave.matrixFromQuat(np.array([np.sqrt(2)/2, 0, np.sqrt(2)/2, 0]))
    

    def __init__(self, quat, pos, parent):
        self.pose = np.hstack([quat, pos])
        self.mat = rave.matrixFromPose(self.pose)
        self.parent = parent
            
    def GetTargetPose(self, obj):       
        mat = obj.GetTransform().dot(self.mat).dot(Grasp.initial)
        pose = rave.poseFromMatrix(mat)
        objPose = rave.poseFromMatrix(obj.GetTransform())
        if self.parent.grasps.index(self) and np.sign((pose - objPose)[-3]) < 0:
            return pose
        
